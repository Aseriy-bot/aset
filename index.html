<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="https://www.dawasa.go.tz/site/images/emblem.png" type="image/png">
<title>DAWASA Flowmeter Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --radius: 20px;
    --shadow: 0 7px 25px rgba(0,0,0,.08);
  }
  [data-theme="light"] {
    --brand: rgb(0, 123, 255);
    --bg: #f0faff;
    --card: #f0faff;
    --muted: rgb(0, 123, 255);
    --text: #000000;
    --table-bg: #fafcff;
    --thead-bg: #eef2fb;
    --border: #e6edf7;
    --shadow: 0px 7px 25px rgba(0, 0, 0, 0.137);
  }
  [data-theme="dark"] {
    --brand: #1a1a1a;
    --bg: #2a2a2a;
    --card: #2a2a2a;
    --muted: #ffffff;
    --text: #ffffff;
    --table-bg: #222;
    --thead-bg: #333;
    --border: #444;
    --shadow: 0px 7px 25px rgba(0, 0, 0, 0.589);
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Poppins", sans-serif;
    color: var(--text);
  }
  body {
    min-height: 100vh;
    background: var(--bg);
    overflow-x: hidden;
    position: relative;
  }

  /* Login Page Styles */
  .login-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, var(--brand) 0%, #0057b3d7 100%), url('https://www.dawasa.go.tz/site/images/emblem.png');
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    padding: 20px;
  }
  
  .login-card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 40px;
    width: 100%;
    max-width: 450px;
    text-align: center;
  }
  
  .login-logo {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    display: block;
  }
  
  .login-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: rgb(0, 123, 255);
  }
  
  .login-subtitle {
    font-size: 1rem;
    margin-bottom: 30px;
    color: var(--text);
  }
  
  .login-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .form-group {
    text-align: left;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
  }
  
  .form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
    color: var(--text);
    background: var(--card);
  }
  
  .form-group input:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
  }
  
  .login-btn {
    background: var(--brand);
    color: #ffffff;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .login-btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
  }
  
  .login-footer {
    margin-top: 30px;
    font-size: 0.9rem;
    color: var(--text);
  }

  /* Sign Up Form Styles */
  .signup-form {
    display: none;
    flex-direction: column;
    gap: 20px;
  }
  
  .form-switch {
    margin-top: 20px;
    font-size: 0.9rem;
    color: var(--text);
  }
  
  .form-switch a {
    color: rgb(0, 123, 255);
    text-decoration: none;
    cursor: pointer;
    font-weight: 500;
  }
  
  .form-switch a:hover {
    text-decoration: underline;
  }
  
  .error-message {
    color: #dc3545;
    font-size: 0.8rem;
    margin-top: 5px;
    display: none;
  }

  /* Clear history button */
  #clearHistoryBtn:hover {
    color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 50%;
    width: 20px;
    height: 20px;
  }

  /* Sidebar */
  .navigation {
    position: fixed;
    width: 300px;
    height: 100%;
    background: var(--brand);
    border-left: 10px solid var(--brand);
    transition: .5s;
    overflow: hidden;
    z-index: 1000;
  }
  .navigation.active { width: 80px; }
  .navigation ul { position: absolute; top: 0; left: 0; width: 100%; }
  .navigation ul li { position: relative; width: 100%; list-style: none; border-top-left-radius: 30px; border-bottom-left-radius: 30px; }
  .navigation ul li:hover, .navigation ul li.hovered, .navigation ul li.active { background: var(--card); }
  .navigation ul li:nth-child(1) { margin-bottom: 40px; pointer-events: none; }
  .navigation ul li a { display: flex; align-items: center; text-decoration: none; color: #fff; }
  .navigation ul li:hover a, .navigation ul li.hovered a, .navigation ul li.active a { color: var(--brand); }
  .navigation ul li a .icon { display: block; min-width: 60px; height: 60px; line-height: 75px; text-align: center; }
  .navigation ul li a .icon ion-icon { font-size: 1.75rem; }
  .navigation ul li a .title { 
    display: block; 
    padding: 0 10px; 
    height: 60px; 
    line-height: 60px; 
    white-space: nowrap; 
  }
  .navigation ul li:nth-child(1) a .title {
    font-size: 1.8rem;
    font-weight: 700;
  }
  .navigation ul li:hover a::before, .navigation ul li.hovered a::before, .navigation ul li.active a::before {
    content: ""; position: absolute; right: 0; top: -50px; width: 50px; height: 50px; border-radius: 50%; box-shadow: 35px 35px 0 10px var(--card); pointer-events: none;
  }
  .navigation ul li:hover a::after, .navigation ul li.hovered a::after, .navigation ul li.active a::after {
    content: ""; position: absolute; right: 0; bottom: -50px; width: 50px; height: 50px; border-radius: 50%; box-shadow: 35px -35px 0 10px var(--card); pointer-events: none;
  }

  /* Main */
  .main {
    position: absolute;
    width: calc(100% - 300px);
    left: 300px;
    min-height: 100vh;
    background: var(--bg);
    transition: .5s;
    padding: 20px;
    display: flex;
    flex-direction: column;
    display: none;
  }
  .main.active { width: calc(100% - 80px); left: 80px; }
  
  /* Topbar */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 60px;
    padding: 0 10px;
    position: relative;
    z-index: 100;
  }
  .toggle {
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2.2rem;
    cursor: pointer;
    z-index: 200;
    color: var(--text);
  }
  .search {
    position: relative;
    width: 420px;
    margin: 0 10px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .search label { display: none; }
  .page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: rgb(0, 123, 255);
    text-align: center;
  }
  .user {
    width: 70px;
    height: 70px;
    border-radius: 5%;
    overflow: hidden;
    cursor: pointer;
    background-color: #f0faff;
  }
  .user img { width: 100%; height: 100%; object-fit: cover; }

  /* Theme Toggle and Logout */
  .theme-toggle {
    position: fixed;
    bottom: 85px;
    left: 20px;
    width: 50px;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    cursor: pointer;
    background: var(--card);
    border-radius: 50%;
    box-shadow: var(--shadow);
    z-index: 1000;
    transition: all 0.3s;
    color: var(--text);
  }
  
  .logout-btn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    cursor: pointer;
    background: var(--card);
    border-radius: 50%;
    box-shadow: var(--shadow);
    z-index: 1000;
    transition: all 0.3s;
    border: none;
    color: var(--text);
  }
  
  .logout-btn:hover, .theme-toggle:hover {
    transform: scale(1.1);
  }

  /* NEW: Hide logout button when login page is visible */
  #loginPage:not([style*="display: none"]) ~ .logout-btn {
    display: none;
  }

  /* Dashboard grid */
  .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-gap: 20px; }
  .grid-5 { grid-template-columns: repeat(4, 1fr); }
  .flow-card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 0;
  }
  .flow-title { font-weight: 600; font-size: 1.1rem; color: var(--text); }
  .flow-metrics {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  .flow-metrics > div {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .flow-metric { font-size: 0.95rem; color: var(--text); }
  .flow-metric span { font-weight: 600; color: rgb(0, 123, 255); }
  .flow-unit { font-size: 0.9rem; color: var(--brand); }
  .chart-wrap { width: 100%; height: 220px; min-height: 200px; }
  .table-wrap {
    overflow: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
    -webkit-overflow-scrolling: touch;
  }
  table { width: 100%; border-collapse: collapse; background: var(--table-bg); min-width: 300px; }
  thead td { font-weight: 600; background: var(--thead-bg); color: var(--text); }
  td { padding: 10px; border-bottom: 1px solid var(--border); font-size: .95rem; color: var(--text); }
  .muted { color: var(--muted); font-size: .9rem; }

  .views { display: none; }
  .views.active { display: grid; }

  /* Individual flowmeter layout */
  .flowmeter-layout {
    display: grid;
    grid-template-columns: 1fr 2fr;
    grid-gap: 20px;
    width: 100%;
    height: calc(100vh - 100px);
  }
  .flowmeter-layout .table-wrap { height: 100%; overflow-y: auto; }
  .flowmeter-layout .chart-wrap { height: 100%; }

  /* Mobile overlay for sidebar */
  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
  }

  /* Bottom-right text (replacing footer) */
  .bottom-right-text {
    align-self: flex-end;
    /* margin-top: auto; */
    margin-left: auto;
    padding: 10px;
    font-size: 0.7rem;
    color: var(--muted);
    opacity: 0.7;
    text-align: right;
  }

  /* NEW: Username display above the "Powered by" text */
  .username-display {
    align-self: flex-end;
    margin-top: auto;
    margin-left: auto;
    padding-top: 10px;
    padding-right: 10px;
    font-size: 1rem;
    color: var(--muted);
    opacity: 0.7;
    text-align: right;
  }

/* Responsive adjustments */
@media (max-width: 991px) {
  .bottom-right-text, .username-display {
    font-size: 0.75rem;
    padding: 8px;
  }
}

@media (max-width: 600px) {
  .bottom-right-text, .username-display {
    font-size: 0.7rem;
    padding: 5px;
  }
}

  #dashboardView{
    padding-top: 10px;
  }
  
  @media (max-width: 991px) {
    .bottom-right-text, .bottom-left-text, .username-display {
      font-size: 0.75rem;
      padding: 8px;
    }
    .bottom-left-text {
      left: 15px;
      bottom: 8px;
    }
  }
  
  @media (max-width: 600px) {
    .bottom-right-text, .bottom-left-text, .username-display {
      font-size: 0.7rem;
      padding: 5px;
    }
    .bottom-left-text {
      left: 10px;
      bottom: 5px;
    }
  }

  /* Responsive Design */
  @media (max-width: 1400px) { .grid-5 { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 1200px) { .grid-5 { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 991px) {
    .navigation { width: 80px; transform: translateX(-100%); z-index: 1000; }
    .navigation.active { transform: translateX(0); width: 300px; }
    .main { width: 100%; left: 0; padding: 15px; }
    .main.active { width: 100%; left: 0; }
    .overlay.active { display: block; }
    .flowmeter-layout { grid-template-columns: 1fr; grid-gap: 15px; height: auto; }
    .flowmeter-layout .chart-wrap { height: 400px; }
    .page-title {font-size: 1.2rem; width: 100%; text-align: center; position: absolute; left: 50%; transform: translateX(-50%);}
    .toggle { position: relative; z-index: 1001; }
    .theme-toggle, .logout-btn { bottom: 15px; left: 15px; width: 40px; height: 40px; font-size: 1.2rem; }
    .theme-toggle { bottom: 65px; }
  }
  @media (max-width: 768px) {
    .grid-5 { grid-template-columns: 1fr; grid-gap: 15px; }
    .search { width: auto; max-width: 250px; }
    .topbar { flex-wrap: wrap; height: auto; padding: 10px 0; }
    .toggle { order: 1; }
    .search { order: 3; width: 100%; max-width: 100%; margin: 10px 0 0 0; justify-content: flex-start; }
    .user { order: 2; width: 65px; height: 65px; }
    .login-card { padding: 30px 20px; }
  }
  @media (max-width: 600px) {
    .navigation.active { width: 100%; max-width: 300px; }
    .flow-card { padding: 15px; }
    .chart-wrap { height: 200px; }
    .flowmeter-layout .chart-wrap { height: 300px; }
    td { padding: 8px 5px; font-size: 0.85rem; }
    .flow-title { font-size: 1rem; }
    .page-title { font-size: 1.1rem; }
    .theme-toggle, .logout-btn { bottom: 10px; left: 10px; width: 35px; height: 35px; font-size: 1rem; }
    .theme-toggle { bottom: 55px; }
  }
  @media (max-width: 480px) {
    .main { padding: 10px; }
    .grid { grid-gap: 15px; }
    .flowmeter-layout { grid-gap: 15px; }
    .flowmeter-layout .chart-wrap { height: 250px; }
  }
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="login-container">
  <div class="login-card">
    <img src="https://www.dawasa.go.tz/site/images/logo.png" alt="DAWASA Logo" class="login-logo">
    <h1 class="login-title">DAWASA Flowmeter Dashboard</h1>
    <p class="login-subtitle">Please Log in to access the monitoring system</p>
    
    <!-- Login Form -->
    <form class="login-form" id="loginForm">
      <div class="form-group">
        <label for="username">Email/Username</label>
        <div style="position: relative;">
          <input type="text" id="username" placeholder="Enter your email/username" required list="previousLogins">
          <datalist id="previousLogins">
            <!-- Previous logins will be populated here -->
          </datalist>
          <button type="button" id="clearHistoryBtn" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 12px; color: #999;" title="Clear history">
            ×
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter your password" required>
      </div>
      
      <button type="submit" class="login-btn">Log In</button>
    </form>
    
    <!-- Sign Up Form -->
    <form class="signup-form" id="signupForm">
      <div class="form-group">
        <label for="signupEmail">Email</label>
        <input type="email" id="signupEmail" placeholder="Enter your email (@dawasa.go.tz)" required>
        <div class="error-message" id="emailError">Email must end with @dawasa.go.tz</div>
      </div>
      
      <div class="form-group">
        <label for="signupUsername">Username</label>
        <input type="text" id="signupUsername" placeholder="Choose a username" required>
      </div>
      
      <div class="form-group">
        <label for="signupPassword">Password</label>
        <input type="password" id="signupPassword" placeholder="Create a password" required>
      </div>
      
      <button type="submit" class="login-btn">Create Account</button>
    </form>
    
    <div class="form-switch">
      <span id="loginSwitch">Don't have an account? <a id="switchToSignup">Sign Up</a></span>
      <span id="signupSwitch" style="display: none;">Already have an account? <a id="switchToLogin">Log In</a></span>
    </div>
    
    <p class="login-footer">For authorized personnel only</p>
  </div>
</div>

<!-- Overlay for mobile sidebar -->
<div class="overlay" id="overlay"></div>

<!-- Sidebar -->
<div class="navigation" id="navigation">
  <ul>
    <li>
      <a href="#"><span class="icon"><ion-icon name="water-outline"></ion-icon></span><span class="title">DAWASA</span></a>
    </li>
    <li class="active"><a href="#" data-view="dashboard"><span class="icon"><ion-icon name="home-outline"></ion-icon></span><span class="title">Upper Ruvu TM</span></a></li>
    <li><a href="#" data-view="fm1"><span class="icon"><ion-icon name="speedometer-outline"></ion-icon></span><span class="title">Flowmeter 01-SA</span></a></li>
    <li><a href="#" data-view="fm2"><span class="icon"><ion-icon name="speedometer-outline"></ion-icon></span><span class="title">Flowmeter 02-SA</span></a></li>
    <li><a href="#" data-view="fm3"><span class="icon"><ion-icon name="speedometer-outline"></ion-icon></span><span class="title">Flowmeter 03-SB</span></a></li>
    <li><a href="#" data-view="fm4"><span class="icon"><ion-icon name="speedometer-outline"></ion-icon></span><span class="title">Flowmeter 04-SB</span></a></li>
    <li><a href="#" data-view="fm5"><span class="icon"><ion-icon name="speedometer-outline"></ion-icon></span><span class="title">Flowmeter 05-WTP</span></a></li>
  </ul>
</div>

<!-- Main -->
<div class="main" id="main">
  <div class="topbar">
    <div class="toggle" id="toggle"><ion-icon name="menu-outline"></ion-icon></div>
    <div class="search">
      <label>
        <input type="text" placeholder="Search here">
        <ion-icon name="search-outline"></ion-icon>
      </label>
      <div class="page-title" id="pageTitle">DAWASA Flowmeters</div>
    </div>
    <div class="user"><img src="https://www.dawasa.go.tz/site/images/logo.png" alt="User"></div>
  </div>

  <!-- DASHBOARD: 5 flowmeter cards -->
  <div id="dashboardView" class="views active grid grid-5">
    <div class="flow-card" id="fm1Card">
      <div class="flow-title">Flowmeter 01-SA</div>
      <div class="flow-metrics">
        <div>
          <div class="flow-metric">Latest Flowrate: <span id="fm1Latest">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Total Flow Today: <span id="fm1Total">0.00</span> <span class="flow-unit">m³</span></div>
        </div>
        <div>
          <div class="flow-metric">Average Flow Rate: <span id="fm1Average">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Peak Flow Rate: <span id="fm1Peak">0.00</span> <span class="flow-unit">m³/h</span></div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="fm1Chart"></canvas></div>
    </div>

    <div class="flow-card" id="fm2Card">
      <div class="flow-title">Flowmeter 02-SA</div>
      <div class="flow-metrics">
        <div>
          <div class="flow-metric">Latest Flowrate: <span id="fm2Latest">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Total Flow Today: <span id="fm2Total">0.00</span> <span class="flow-unit">m³</span></div>
        </div>
        <div>
          <div class="flow-metric">Average Flow Rate: <span id="fm2Average">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Peak Flow Rate: <span id="fm2Peak">0.00</span> <span class="flow-unit">m³/h</span></div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="fm2Chart"></canvas></div>
    </div>

    <div class="flow-card" id="fm3Card">
      <div class="flow-title">Flowmeter 03-SB</div>
      <div class="flow-metrics">
        <div>
          <div class="flow-metric">Latest Flowrate: <span id="fm3Latest">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Total Flow Today: <span id="fm3Total">0.00</span> <span class="flow-unit">m³</span></div>
        </div>
        <div>
          <div class="flow-metric">Average Flow Rate: <span id="fm3Average">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class.flow-metric">Peak Flow Rate: <span id="fm3Peak">0.00</span> <span class="flow-unit">m³/h</span></div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="fm3Chart"></canvas></div>
    </div>

    <div class="flow-card" id="fm4Card">
      <div class="flow-title">Flowmeter 04-SB</div>
      <div class="flow-metrics">
        <div>
          <div class="flow-metric">Latest Flowrate: <span id="fm4Latest">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Total Flow Today: <span id="fm4Total">0.00</span> <span class="flow-unit">m³</span></div>
        </div>
        <div>
          <div class="flow-metric">Average Flow Rate: <span id="fm4Average">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Peak Flow Rate: <span id="fm4Peak">0.00</span> <span class="flow-unit">m³/h</span></div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="fm4Chart"></canvas></div>
    </div>

    <div class="flow-card" id="fm5Card">
      <div class="flow-title">Flowmeter 05-WTP</div>
      <div class="flow-metrics">
        <div>
          <div class="flow-metric">Latest Flowrate: <span id="fm5Latest">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Total Flow Today: <span id="fm5Total">0.00</span> <span class="flow-unit">m³</span></div>
        </div>
        <div>
          <div class="flow-metric">Average Flow Rate: <span id="fm5Average">0.00</span> <span class="flow-unit">m³/h</span></div>
          <div class="flow-metric">Peak Flow Rate: <span id="fm5Peak">0.00</span> <span class="flow-unit">m³/h</span></div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="fm5Chart"></canvas></div>
    </div>
  </div>

  <!-- INDIVIDUAL VIEWS -->
  <div id="fm1View" class="views">
    <div class="flowmeter-layout">
      <div class="flow-card">
        <div class="flow-title">Flowmeter 01</div>
        <div class="flow-metrics">
          <div>
            <div class="flow-metric">Latest Flowrate: <span id="fm1Latest_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Total Flow Today: <span id="fm1Total_single">0.00</span> <span class="flow-unit">m³</span></div>
          </div>
          <div>
            <div class="flow-metric">Average Flow Rate: <span id="fm1Average_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Peak Flow Rate: <span id="fm1Peak_single">0.00</span> <span class="flow-unit">m³/h</span></div>
          </div>
        </div>
        <div class="flow-title">Flow Rate Table Values</div>
        <div class="table-wrap">
          <table><thead><tr><td>Date</td><td>Time</td><td>Flowrate (m³/h)</td></tr></thead><tbody id="fm1Table_single"></tbody></table>
        </div>
        <div class="muted">Last 20 readings</div>
      </div>
      <div class="flow-card">
        <div class="flow-title">Flow Rate Chart</div>
        <div class="chart-wrap"><canvas id="fm1Chart_single"></canvas></div>
      </div>
    </div>
  </div>

  <div id="fm2View" class="views">
    <div class="flowmeter-layout">
      <div class="flow-card">
        <div class="flow-title">Flowmeter 02</div>
        <div class="flow-metrics">
          <div>
            <div class="flow-metric">Latest Flowrate: <span id="fm2Latest_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Total Flow Today: <span id="fm2Total_single">0.00</span> <span class="flow-unit">m³</span></div>
          </div>
          <div>
            <div class="flow-metric">Average Flow Rate: <span id="fm2Average_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Peak Flow Rate: <span id="fm2Peak_single">0.00</span> <span class="flow-unit">m³/h</span></div>
          </div>
        </div>
        <div class="flow-title">Flow Rate Table Values</div>
        <div class="table-wrap">
          <table><thead><tr><td>Date</td><td>Time</td><td>Flowrate (m³/h)</td></tr></thead><tbody id="fm2Table_single"></tbody></table>
        </div>
        <div class="muted">Last 20 readings</div>
      </div>
      <div class="flow-card">
        <div class="flow-title">Flow Rate Chart</div>
        <div class="chart-wrap"><canvas id="fm2Chart_single"></canvas></div>
      </div>
    </div>
  </div>

  <div id="fm3View" class="views">
    <div class="flowmeter-layout">
      <div class="flow-card">
        <div class="flow-title">Flowmeter 03</div>
        <div class="flow-metrics">
          <div>
            <div class="flow-metric">Latest Flowrate: <span id="fm3Latest_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Total Flow Today: <span id="fm3Total_single">0.00</span> <span class="flow-unit">m³</span></div>
          </div>
          <div>
            <div class="flow-metric">Average Flow Rate: <span id="fm3Average_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Peak Flow Rate: <span id="fm3Peak_single">0.00</span> <span class="flow-unit">m³/h</span></div>
          </div>
        </div>
        <div class="flow-title">Flow Rate Table Values</div>
        <div class="table-wrap">
          <table><thead><tr><td>Date</td><td>Time</td><td>Flowrate (m³/h)</td></tr></thead><tbody id="fm3Table_single"></tbody></table>
        </div>
        <div class="muted">Last 20 readings</div>
      </div>
      <div class="flow-card">
        <div class="flow-title">Flow Rate Chart</div>
        <div class="chart-wrap"><canvas id="fm3Chart_single"></canvas></div>
      </div>
    </div>
  </div>

  <div id="fm4View" class="views">
    <div class="flowmeter-layout">
      <div class="flow-card">
        <div class="flow-title">Flowmeter 04</div>
        <div class="flow-metrics">
          <div>
            <div class="flow-metric">Latest Flowrate: <span id="fm4Latest_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Total Flow Today: <span id="fm4Total_single">0.00</span> <span class="flow-unit">m³</span></div>
          </div>
          <div>
            <div class="flow-metric">Average Flow Rate: <span id="fm4Average_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Peak Flow Rate: <span id="fm4Peak_single">0.00</span> <span class="flow-unit">m³/h</span></div>
          </div>
        </div>
        <div class="flow-title">Flow Rate Table Values</div>
        <div class="table-wrap">
          <table><thead><tr><td>Date</td><td>Time</td><td>Flowrate (m³/h)</td></tr></thead><tbody id="fm4Table_single"></tbody></table>
        </div>
        <div class="muted">Last 20 readings</div>
      </div>
      <div class="flow-card">
        <div class="flow-title">Flow Rate Chart</div>
        <div class="chart-wrap"><canvas id="fm4Chart_single"></canvas></div>
      </div>
    </div>
  </div>

  <div id="fm5View" class="views">
    <div class="flowmeter-layout">
      <div class="flow-card">
        <div class="flow-title">Flowmeter 05</div>
        <div class="flow-metrics">
          <div>
            <div class="flow-metric">Latest Flowrate: <span id="fm5Latest_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Total Flow Today: <span id="fm5Total_single">0.00</span> <span class="flow-unit">m³</span></div>
          </div>
          <div>
            <div class="flow-metric">Average Flow Rate: <span id="fm5Average_single">0.00</span> <span class="flow-unit">m³/h</span></div>
            <div class="flow-metric">Peak Flow Rate: <span id="fm5Peak_single">0.00</span> <span class="flow-unit">m³/h</span></div>
          </div>
        </div>
        <div class="flow-title">Flow Rate Table Values</div>
        <div class="table-wrap">
          <table><thead><tr><td>Date</td><td>Time</td><td>Flowrate (m³/h)</td></tr></thead><tbody id="fm5Table_single"></tbody></table>
        </div>
        <div class="muted">Last 20 readings</div>
      </div>
      <div class="flow-card">
        <div class="flow-title">Flow Rate Chart</div>
        <div class="chart-wrap"><canvas id="fm5Chart_single"></canvas></div>
      </div>
    </div>
  </div>

  <!-- NEW: Username display above the "Powered by" text -->
  <div class="username-display" id="usernameDisplay"></div>

  <div class="bottom-right-text">
    Powered by Bitlynx Reporting Solutions, DSM
  </div>
</div>

<!-- Theme Toggle Button -->
<div class="theme-toggle" id="themeToggle"><ion-icon name="moon-outline"></ion-icon></div>

<!-- Logout Button -->
<button class="logout-btn" id="logoutBtn" title="Logout"><ion-icon name="log-out-outline"></ion-icon></button>

<!-- Libs -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
/* ---------------------- Previous Logins Management ---------------------- */
function saveLoginHistory(identifier) {
  let loginHistory = JSON.parse(localStorage.getItem('dawasa_login_history') || '[]');
  
  // Add new identifier if not already in history
  if (!loginHistory.includes(identifier)) {
    loginHistory.push(identifier);
    // Keep only the last 5 logins
    if (loginHistory.length > 5) {
      loginHistory = loginHistory.slice(-5);
    }
    localStorage.setItem('dawasa_login_history', JSON.stringify(loginHistory));
  }
  
  updateLoginSuggestions();
}

function getLoginHistory() {
  return JSON.parse(localStorage.getItem('dawasa_login_history') || '[]');
}

function updateLoginSuggestions() {
  const loginHistory = getLoginHistory();
  const datalist = document.getElementById('previousLogins');
  
  // Clear existing options
  datalist.innerHTML = '';
  
  // Add new options from login history
  loginHistory.forEach(login => {
    const option = document.createElement('option');
    option.value = login;
    datalist.appendChild(option);
  });
}

function clearLoginHistory() {
  localStorage.removeItem('dawasa_login_history');
  updateLoginSuggestions();
}

/* ---------------------- User Management ---------------------- */
function validateDawasaEmail(email) {
  return email.endsWith('@dawasa.go.tz');
}

function registerUser(email, username, password) {
  const users = JSON.parse(localStorage.getItem('dawasa_users') || '{}');
  
  // Check if email already exists
  if (users[email]) {
    return { success: false, message: 'Email already registered' };
  }
  
  // Check if username already exists
  for (const userEmail in users) {
    if (users[userEmail].username === username) {
      return { success: false, message: 'Username already taken' };
    }
  }
  
  // Store user
  users[email] = {
    username: username,
    password: password, // In a real app, you should hash this
    email: email
  };
  
  localStorage.setItem('dawasa_users', JSON.stringify(users));
  return { success: true };
}

function authenticateUser(identifier, password) {
  const users = JSON.parse(localStorage.getItem('dawasa_users') || '{}');
  
  // Check if identifier is email or username
  let user = null;
  
  // First try as email
  if (users[identifier]) {
    user = users[identifier];
  } else {
    // Search by username
    for (const email in users) {
      if (users[email].username === identifier) {
        user = users[email];
        break;
      }
    }
  }
  
  if (user && user.password === password) {
    return { success: true, user: user };
  }
  
  return { success: false, message: 'Invalid credentials' };
}

/* ---------------------- Login/Signup UI ---------------------- */
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const switchToSignup = document.getElementById('switchToSignup');
const switchToLogin = document.getElementById('switchToLogin');
const loginSwitch = document.getElementById('loginSwitch');
const signupSwitch = document.getElementById('signupSwitch');
const emailError = document.getElementById('emailError');
const signupEmail = document.getElementById('signupEmail');

// Initialize login suggestions when page loads
document.addEventListener('DOMContentLoaded', function() {
  updateLoginSuggestions();
});

// Clear login history button
document.getElementById('clearHistoryBtn').addEventListener('click', function(e) {
  e.preventDefault();
  if (confirm('Clear all login history?')) {
    clearLoginHistory();
  }
});

// Switch between login and signup forms
switchToSignup.addEventListener('click', function() {
  loginForm.style.display = 'none';
  signupForm.style.display = 'flex';
  loginSwitch.style.display = 'none';
  signupSwitch.style.display = 'block';
});

switchToLogin.addEventListener('click', function() {
  signupForm.style.display = 'none';
  loginForm.style.display = 'flex';
  signupSwitch.style.display = 'none';
  loginSwitch.style.display = 'block';
  emailError.style.display = 'none';
});

// Validate email on signup
signupEmail.addEventListener('blur', function() {
  if (this.value && !validateDawasaEmail(this.value)) {
    emailError.style.display = 'block';
  } else {
    emailError.style.display = 'none';
  }
});

// Handle signup form submission
signupForm.addEventListener('submit', function(e) {
  e.preventDefault();
  
  const email = document.getElementById('signupEmail').value;
  const username = document.getElementById('signupUsername').value;
  const password = document.getElementById('signupPassword').value;
  
  // Validate email
  if (!validateDawasaEmail(email)) {
    emailError.style.display = 'block';
    return;
  }
  
  // Register user
  const result = registerUser(email, username, password);
  
  if (result.success) {
    alert('Account created successfully! Please log in.');
    switchToLogin.click();
    document.getElementById('username').value = email;
  } else {
    alert(result.message);
  }
});

/* ---------------------- Login Functionality ---------------------- */
const loginPage = document.getElementById('loginPage');
const main = document.getElementById('main');
const logoutBtn = document.getElementById('logoutBtn');
const usernameDisplay = document.getElementById('usernameDisplay');

// Check if user is already logged in
if (localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('currentUser')) {
  const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  loginPage.style.display = 'none';
  main.style.display = 'flex';
  usernameDisplay.textContent = `Logged in as: ${currentUser.username}`;
}

// Handle login form submission
loginForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const identifier = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  // Authenticate user
  const result = authenticateUser(identifier, password);
  
  if (result.success) {
    // Save this login to history
    saveLoginHistory(identifier);
    
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('currentUser', JSON.stringify(result.user));
    loginPage.style.display = 'none';
    main.style.display = 'flex';
    usernameDisplay.textContent = `Logged in as: ${result.user.username}`;
  } else {
    alert(result.message || 'Login failed');
  }
});

// Handle logout
logoutBtn.addEventListener('click', function() {
  localStorage.removeItem('isLoggedIn');
  localStorage.removeItem('currentUser');
  loginPage.style.display = 'flex';
  main.style.display = 'none';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  usernameDisplay.textContent = '';
});

/* ---------------------- UI: sidebar & views ---------------------- */
const navigation = document.querySelector(".navigation");
const toggle = document.querySelector(".toggle");
const overlay = document.querySelector("#overlay");
const themeToggle = document.querySelector("#themeToggle");
const menuLinks = document.querySelectorAll(".navigation li a");
const pageTitle = document.getElementById("pageTitle");

// Theme toggle
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", currentTheme);
  themeToggle.innerHTML = `<ion-icon name="${currentTheme === 'dark' ? 'sunny-outline' : 'moon-outline'}"></ion-icon>`;
  localStorage.setItem("theme", currentTheme);
}

// Load theme from localStorage
const savedTheme = localStorage.getItem("theme") || "light";
document.documentElement.setAttribute("data-theme", savedTheme);
themeToggle.innerHTML = `<ion-icon name="${savedTheme === 'dark' ? 'sunny-outline' : 'moon-outline'}"></ion-icon>`;
themeToggle.addEventListener("click", toggleTheme);

// Check if device is mobile
function isMobile() {
  return window.innerWidth <= 991;
}

// Toggle sidebar
function toggleSidebar() {
  navigation.classList.toggle("active");
  main.classList.toggle("active");
  overlay.classList.toggle("active");
}

// Close sidebar
function closeSidebar() {
  navigation.classList.remove("active");
  main.classList.remove("active");
  overlay.classList.remove("active");
}

toggle.onclick = toggleSidebar;
overlay.onclick = closeSidebar;

function showView(viewId) {
  document.querySelectorAll(".views").forEach(v => v.classList.remove("active"));
  document.querySelectorAll(".navigation li").forEach(li => li.classList.remove("active"));
  
  if (viewId === "dashboard") {
    document.getElementById("dashboardView").classList.add("active");
    pageTitle.textContent = "DAWASA Flowmeters";
    document.querySelector('.navigation li a[data-view="dashboard"]').parentElement.classList.add("active");
  } else {
    document.getElementById(viewId + "View").classList.add("active");
    const flowmeterNumber = viewId.replace('fm', '');
    const formattedNumber = flowmeterNumber.length === 1 ? '0' + flowmeterNumber : flowmeterNumber;
    pageTitle.textContent = "Flowmeter " + formattedNumber;
    document.querySelector(`.navigation li a[data-view="${viewId}"]`).parentElement.classList.add("active");
  }
  
  if (isMobile()) {
    closeSidebar();
  }
}

menuLinks.forEach(a => {
  a.addEventListener("click", e => {
    e.preventDefault();
    const view = a.getAttribute("data-view") || "dashboard";
    showView(view);
  });
});

/* ---------------------- Chart helpers ---------------------- */
const MAX_POINTS_DASHBOARD = 10;
const MAX_POINTS_SINGLE = 20;
const charts = {};
const flowmeterData = {
  fm1: { labels: [], values: [], total: 0, average: 0, peak: 0, today: new Date().toISOString().slice(0, 10) },
  fm2: { labels: [], values: [], total: 0, average: 0, peak: 0, today: new Date().toISOString().slice(0, 10) },
  fm3: { labels: [], values: [], total: 0, average: 0, peak: 0, today: new Date().toISOString().slice(0, 10) },
  fm4: { labels: [], values: [], total: 0, average: 0, peak: 0, today: new Date().toISOString().slice(0, 10) },
  fm5: { labels: [], values: [], total: 0, average: 0, peak: 0, today: new Date().toISOString().slice(0, 10) }
};

const chartColors = {
  fm1: { border: '#007BFF', background: 'rgba(0, 123, 255, 0.3)' },
  fm2: { border: '#28A745', background: 'rgba(40, 167, 69, 0.3)' },
  fm3: { border: '#DC3545', background: 'rgba(220, 53, 69, 0.3)' },
  fm4: { border: '#FFC107', background: 'rgba(255, 193, 7, 0.3)' },
  fm5: { border: '#6F42C1', background: 'rgba(111, 66, 193, 0.3)' }
};

function createLineChart(canvasId, fmKey) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Flowrate',
        data: [],
        fill: true,
        borderColor: chartColors[fmKey].border,
        backgroundColor: chartColors[fmKey].background,
        tension: 0.35,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: {
        x: { title: { display: true, text: 'Time' } },
        y: { title: { display: true, text: 'Flowrate (m³/h)' }, beginAtZero: true }
      }
    }
  });
}

function pushPoint(chart, label, value, maxPoints) {
  if (!chart) return;
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(Number(value));
  if (chart.data.labels.length > maxPoints) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

function prependRow(tbodyId, dateStr, timeStr, flow, maxRows) {
  const tb = document.getElementById(tbodyId);
  if (!tb) return;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${dateStr}</td><td>${timeStr}</td><td>${Number(flow).toFixed(2)}</td>`;
  tb.prepend(tr);
  while (tb.rows.length > maxRows) { tb.deleteRow(tb.rows.length - 1); }
}

function updateMetricsDisplay(fmKey, latest, total, average, peak) {
  const dashboardLatest = document.getElementById(`${fmKey}Latest`);
  const dashboardTotal = document.getElementById(`${fmKey}Total`);
  const dashboardAverage = document.getElementById(`${fmKey}Average`);
  const dashboardPeak = document.getElementById(`${fmKey}Peak`);
  if (dashboardLatest) dashboardLatest.textContent = Number(latest).toFixed(2);
  if (dashboardTotal) dashboardTotal.textContent = Number(total).toFixed(2);
  if (dashboardAverage) dashboardAverage.textContent = Number(average).toFixed(2);
  if (dashboardPeak) dashboardPeak.textContent = Number(peak).toFixed(2);
  
  const singleLatest = document.getElementById(`${fmKey}Latest_single`);
  const singleTotal = document.getElementById(`${fmKey}Total_single`);
  const singleAverage = document.getElementById(`${fmKey}Average_single`);
  const singlePeak = document.getElementById(`${fmKey}Peak_single`);
  if (singleLatest) singleLatest.textContent = Number(latest).toFixed(2);
  if (singleTotal) singleTotal.textContent = Number(total).toFixed(2);
  if (singleAverage) singleAverage.textContent = Number(average).toFixed(2);
  if (singlePeak) singlePeak.textContent = Number(peak).toFixed(2);
}

function syncSingleTable(fmKey) {
  const single = document.getElementById(`${fmKey}Table_single`);
  if (!single) return;
  single.innerHTML = '';
  const data = flowmeterData[fmKey];
  const maxRows = Math.min(data.labels.length, MAX_POINTS_SINGLE);
  for (let i = Math.max(0, data.labels.length - maxRows); i < data.labels.length; i++) {
    prependRow(`${fmKey}Table_single`, data.today, data.labels[i], data.values[i], MAX_POINTS_SINGLE);
  }
}

function syncSingleChart(fmKey) {
  const src = charts[`${fmKey}Chart`];
  const dst = charts[`${fmKey}Chart_single`];
  if (!src || !dst) return;
  dst.data.labels = [...src.data.labels];
  dst.data.datasets[0].data = [...src.data.datasets[0].data];
  if (dst.data.labels.length > MAX_POINTS_SINGLE) {
    dst.data.labels = dst.data.labels.slice(-MAX_POINTS_SINGLE);
    dst.data.datasets[0].data = dst.data.datasets[0].data.slice(-MAX_POINTS_SINGLE);
  }
  dst.update();
}

/* ---------------------- Data persistence ---------------------- */
function saveFlowmeterData(fmKey) {
  localStorage.setItem(`flowmeter_${fmKey}`, JSON.stringify(flowmeterData[fmKey]));
}

function loadFlowmeterData(fmKey) {
  const savedData = localStorage.getItem(`flowmeter_${fmKey}`);
  if (savedData) {
    const data = JSON.parse(savedData);
    if (data.today === new Date().toISOString().slice(0, 10)) {
      flowmeterData[fmKey] = { ...data };
      const maxDash = Math.min(data.labels.length, MAX_POINTS_DASHBOARD);
      const maxSingle = Math.min(data.labels.length, MAX_POINTS_SINGLE);
      for (let i = Math.max(0, data.labels.length - maxDash); i < data.labels.length; i++) {
        pushPoint(charts[`${fmKey}Chart`], data.labels[i], data.values[i], MAX_POINTS_DASHBOARD);
      }
      for (let i = Math.max(0, data.labels.length - maxSingle); i < data.labels.length; i++) {
        prependRow(`${fmKey}Table_single`, data.today, data.labels[i], data.values[i], MAX_POINTS_SINGLE);
      }
      updateMetricsDisplay(fmKey, data.values[data.values.length - 1] || 0, data.total, data.average, data.peak);
      syncSingleChart(fmKey);
    } else {
      localStorage.removeItem(`flowmeter_${fmKey}`);
      flowmeterData[fmKey] = { labels: [], values: [], total: 0, average: 0, peak: 0, today: new Date().toISOString().slice(0, 10) };
    }
  }
}

/* ---------------------- Init charts ---------------------- */
['fm1', 'fm2', 'fm3', 'fm4', 'fm5'].forEach(fm => {
  charts[`${fm}Chart`] = createLineChart(`${fm}Chart`, fm);
  charts[`${fm}Chart_single`] = createLineChart(`${fm}Chart_single`, fm);
  loadFlowmeterData(fm);
});

/* ---------------------- Flowmeter update ---------------------- */
function updateFlowmeter(fmKey, value, dateStr, timeStr) {
  const data = flowmeterData[fmKey];
  const currentDate = new Date().toISOString().slice(0, 10);
  
  if (data.today !== currentDate) {
    data.labels = [];
    data.values = [];
    data.total = 0;
    data.average = 0;
    data.peak = 0;
    data.today = currentDate;
  }
  
  data.labels.push(timeStr);
  data.values.push(Number(value));
  data.total += Number(value);
  data.peak = Math.max(data.peak, Number(value));
  data.average = data.values.length > 0 ? data.total / data.values.length : 0;
  
  if (data.labels.length > MAX_POINTS_SINGLE) {
    data.labels.shift();
    data.values.shift();
  }
  
  updateMetricsDisplay(fmKey, value, data.total, data.average, data.peak);
  pushPoint(charts[`${fmKey}Chart`], timeStr, value, MAX_POINTS_DASHBOARD);
  prependRow(`${fmKey}Table_single`, dateStr, timeStr, value, MAX_POINTS_SINGLE);
  syncSingleChart(fmKey);
  
  saveFlowmeterData(fmKey);
}

/* ---------------------- MQTT Integration ---------------------- */
const broker = "ws://broker.emqx.io:8083/mqtt";
const client = mqtt.connect(broker, { reconnectPeriod: 2000 });

client.on("connect", () => {
  console.log("MQTT connected");
  // Subscribe to the new topics as requested
  client.subscribe("transmiter01txa");  // For flowmeters 1 and 2
  client.subscribe("transmiter01txb");  // For flowmeters 3 and 4
  client.subscribe("transmiter02tx");   // For flowmeter 5 (unchanged)
});

client.on("reconnect", () => console.log("MQTT reconnecting..."));
client.on("error", (err) => console.error("MQTT error:", err?.message || err));

client.on("message", (topic, message) => {
  const ts = new Date();
  const dateStr = ts.toISOString().slice(0, 10);
  const timeStr = ts.toTimeString().split(' ')[0];

  try {
  const txt = message.toString().trim();
  let data;
  try { data = JSON.parse(txt); } catch (e) { data = txt; }

  // CORRECTED: Match the actual subscribed topics
  if (topic === "transmiter01txa") {
    // Handle data for flowmeters 1 and 2
    if (Array.isArray(data) && data.length >= 2) {
      // Update flowmeter 1 with first value
      const val1 = Number(Object.values(data[0])[0]);
      if (!isNaN(val1)) updateFlowmeter('fm1', val1, dateStr, timeStr);
      
      // Update flowmeter 2 with second value
      const val2 = Number(Object.values(data[1])[0]);
      if (!isNaN(val2)) updateFlowmeter('fm2', val2, dateStr, timeStr);
    }
  } else if (topic === "transmiter01txb") {
    // Handle data for flowmeters 3 and 4
    if (Array.isArray(data) && data.length >= 2) {
      // Update flowmeter 3 with first value
      const val3 = Number(Object.values(data[0])[0]);
      if (!isNaN(val3)) updateFlowmeter('fm3', val3, dateStr, timeStr);
      
      // Update flowmeter 4 with second value
      const val4 = Number(Object.values(data[1])[0]);
      if (!isNaN(val4)) updateFlowmeter('fm4', val4, dateStr, timeStr);
    }
  } else if (topic === "transmiter02tx") {
    // Handle data for flowmeter 5 (unchanged)
    let val;
    if (typeof data === 'object' && data !== null) { 
      val = Number(Object.values(data)[0]); 
    } else { 
      val = Number(data); 
    }
    if (!isNaN(val)) updateFlowmeter('fm5', val, dateStr, timeStr);
  }
  } catch (err) { 
    console.error("MQTT message error:", err); 
  }
});

// Handle window resize
window.addEventListener('resize', function() {
  Object.values(charts).forEach(chart => {
    if (chart) chart.resize();
  });
});
</script>

</body>
</html>
